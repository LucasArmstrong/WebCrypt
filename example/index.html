<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="width=device-width, initial-scale=1.0"/>
  <title>webcrypt – Local Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 2rem auto; background: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.6; }
    h1, h2 { color: #58a6ff; }
    .card { background: #161b22; padding: 24px; border-radius: 12px; margin: 20px 0; border: 1px solid #30363d; }
    input, textarea, button { width: 100%; padding: 12px; margin: 8px 0; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; border-radius: 8px; box-sizing: border-box; }
    button { background: #238636; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #2ea043; }
    video { width: 48%; border-radius: 8px; background: #000; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    pre { background: #21262d; padding: 12px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>

  <h1>webcrypt – Local Development Demo</h1>
  <p>Imports directly from <code>src/WebCrypt.js</code> — perfect for testing before publishing</p>

  <script type="module">
    // THIS IS WHAT YOU ASKED FOR — direct import from src/
    import { WebCrypt } from "../src/WebCrypt.js";

    const wc = new WebCrypt();
    const PASSWORD = "demo-secret-2025";

    // Text
    document.getElementById("encryptTextBtn").onclick = async () => {
      const text = document.getElementById("textInput").value.trim();
      if (!text) return alert("Type something!");
      const encrypted = await wc.encryptText(text, PASSWORD);
      document.getElementById("textOutput").textContent = encrypted;
    };

    document.getElementById("decryptTextBtn").onclick = async () => {
      const b64 = document.getElementById("textOutput").textContent;
      if (!b64) return alert("Encrypt first");
      try {
        const decrypted = await wc.decryptText(b64, PASSWORD);
        alert("Decrypted: " + decrypted);
      } catch (e) {
        alert("Wrong password");
      }
    };

    // File
    const download = (blob, name) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById("encryptFileBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pick a file");
      const { blob, filename } = await wc.encryptFile(file, PASSWORD);
      download(blob, filename);
    };

    document.getElementById("decryptFileBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pick a file");
      try {
        const { blob, filename } = await wc.decryptFile(file, PASSWORD);
        download(blob, filename);
      } catch (e) {
        alert("Wrong password");
      }
    };

    // WebRTC
    let pc = null;
    document.getElementById("startCallBtn").onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = stream;

      pc = new RTCPeerConnection();

      stream.getTracks().forEach(async track => {
        const sender = pc.addTrack(track, stream);
        sender.transform = new RTCRtpScriptTransform(await wc.createEncryptTransform(PASSWORD));
      });

      pc.ontrack = async event => {
        event.receiver.transform = new RTCRtpScriptTransform(await wc.createDecryptTransform(PASSWORD));
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      document.getElementById("offerOutput").textContent = btoa(JSON.stringify(offer));
      alert("Offer ready — copy it!");
    };

    document.getElementById("answerBtn").onclick = async () => {
      const b64 = prompt("Paste answer:");
      if (b64 && pc) {
        await pc.setRemoteDescription(JSON.parse(atob(b64)));
        alert("Connected — E2EE active");
      }
    };
  </script>

  <div class="card">
    <h2>1. Text Encryption</h2>
    <textarea id="textInput" rows="4" placeholder="Secret message..."></textarea>
    <button id="encryptTextBtn">Encrypt</button>
    <button id="decryptTextBtn">Decrypt</button>
    <pre id="textOutput">Result appears here</pre>
  </div>

  <div class="card">
    <h2>2. File Encryption</h2>
    <input type="file" id="fileInput" />
    <button id="encryptFileBtn">Encrypt File</button>
    <button id="decryptFileBtn">Decrypt File</button>
    <p>Password: <code>demo-secret-2025</code></p>
  </div>

  <div class="card">
    <h2>3. WebRTC E2EE Call</h2>
    <button id="startCallBtn">Start & Generate Offer</button>
    <pre id="offerOutput">Offer here...</pre>
    <button id="answerBtn">Paste Answer & Connect</button>
    <div class="row">
      <video id="localVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

</body>
</html>